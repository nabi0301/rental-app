{% extends "base.html" %}

{% block title %}{{ 'Edit' if property else 'Add' }} Property{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">{{ 'Edit' if property else 'Add New' }} Property</h2>
                    <form method="POST" enctype="multipart/form-data" 
                          action="{{ url_for('main.edit_property', property_id=property.id) if property else url_for('main.add_property') }}">
                        {{ form.hidden_tag() }}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="title" class="form-label">Title</label>
                                    <input type="text" class="form-control" id="title" name="title" 
                                           value="{{ property.title if property }}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="price" class="form-label">Monthly Rent ($)</label>
                                    <input type="number" class="form-control" id="price" name="price" 
                                           value="{{ property.price if property }}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="bedrooms" class="form-label">Bedrooms</label>
                                    <input type="number" class="form-control" id="bedrooms" name="bedrooms" 
                                           value="{{ property.bedrooms if property }}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="bathrooms" class="form-label">Bathrooms</label>
                                    <input type="number" class="form-control" id="bathrooms" name="bathrooms" 
                                           value="{{ property.bathrooms if property }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="address" class="form-label">Street Address</label>
                                    <input type="text" class="form-control" id="address" name="address" 
                                           value="{{ property.address if property }}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="city" class="form-label">City</label>
                                    <input type="text" class="form-control" id="city" name="city" 
                                           value="{{ property.city if property }}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="state" class="form-label">State</label>
                                    <select class="form-select" id="state" name="state" required>
                                        <option value="">Select State</option>
                                        {% for state in states %}
                                            <option value="{{ state }}" 
                                                    {% if property and property.state == state %}selected{% endif %}>
                                                {{ state }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="zip_code" class="form-label">ZIP Code</label>
                                    <input type="text" class="form-control" id="zip_code" name="zip_code" 
                                           value="{{ property.zip_code if property }}" 
                                           pattern="[0-9]*" required>
                                </div>
                                <div class="mb-3">
                                    <label for="neighborhood" class="form-label">Neighborhood</label>
                                    <input type="text" class="form-control" id="neighborhood" name="neighborhood" 
                                           value="{{ property.neighborhood if property }}">
                                </div>
                                <div class="mb-3">
                                    <label for="property_type" class="form-label">Property Type</label>
                                    <select class="form-select" id="property_type" name="property_type" required>
                                        <option value="">Select Type</option>
                                        {% for type in property_types %}
                                            <option value="{{ type }}" 
                                                    {% if property and property.property_type == type %}selected{% endif %}>
                                                {{ type.replace('_', ' ').title() }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Amenities</label>
                                    <div class="row">
                                        {% for amenity in amenities %}
                                            <div class="col-md-4 mb-2">
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" 
                                                           id="amenity_{{ loop.index }}" 
                                                           name="amenities[]" 
                                                           value="{{ amenity }}"
                                                           {% if property and amenity in property.amenities %}checked{% endif %}>
                                                    <label class="form-check-label" for="amenity_{{ loop.index }}">
                                                        {{ amenity.replace('_', ' ').title() }}
                                                    </label>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div id="map" style="height: 300px;" class="mb-3"></div>
                                <input type="hidden" id="latitude" name="latitude" value="{{ property.latitude if property }}">
                                <input type="hidden" id="longitude" name="longitude" value="{{ property.longitude if property }}">
                                <div class="mb-3">
                                    <label for="available_from" class="form-label">Available From</label>
                                    <input type="date" class="form-control" id="available_from" name="available_from" 
                                           value="{{ property.available_from.strftime('%Y-%m-%d') if property and property.available_from }}" 
                                           required>
                                </div>
                                <div class="mb-3">
                                    <label for="images" class="form-label">Property Images</label>
                                    <input type="file" class="form-control" id="images" name="images[]" accept="image/*"
                                           multiple onchange="previewImages(this);">
                                    <div class="form-text">You can select multiple images. The first image will be the primary image.</div>
                                    
                                    <div id="imagePreviewContainer" class="row mt-2">
                                        {% if property and property.images %}
                                            {% for image in property.images %}
                                                <div class="col-md-4 mb-2">
                                                    <div class="position-relative">
                                                        <img src="{{ image.url }}" class="img-thumbnail" alt="Property image">
                                                        {% if image.is_primary %}
                                                            <span class="badge bg-primary position-absolute top-0 end-0">Primary</span>
                                                        {% endif %}
                                                        <form action="{{ url_for('main.delete_property_image', property_id=property.id, image_id=image.id) }}" 
                                                              method="post" class="position-absolute bottom-0 end-0">
                                                            <button type="submit" class="btn btn-danger btn-sm">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                        {% if not image.is_primary %}
                                                            <form action="{{ url_for('main.set_primary_image', property_id=property.id, image_id=image.id) }}" 
                                                                  method="post" class="position-absolute bottom-0 start-0">
                                                                <button type="submit" class="btn btn-primary btn-sm">
                                                                    Set as Primary
                                                                </button>
                                                            </form>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="4" 
                                      required>{{ property.description if property }}</textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="is_available" name="is_available"
                                   {% if not property or property.is_available %}checked{% endif %}>
                            <label class="form-check-label" for="is_available">Property is Available</label>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">
                                {{ 'Save Changes' if property else 'Add Property' }}
                            </button>
                            <a href="{{ url_for('main.profile') }}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
